// Generated by CoffeeScript 1.9.3
(function() {
  (function($) {
    var S4, defaultParams, settings, syncURL;
    if (!settings in window) {
      window.alert("ERROR! Must set settings.js -- see README");
      throw "ERROR! Must set settings.js -- see README";
    }
    settings = window.settings;
    syncURL = settings.apiBase + "sync";
    defaultParams = {
      token: settings.apiKey,
      seq_no: 0,
      seq_no_global: 0,
      resource_types: JSON.stringify(["projects"])
    };
    $(window).bind("keydown", settings.saveToProjectBind, function(e) {
      var activeURL, syncParams;
      activeURL = window.location.href;
      syncParams = defaultParams;
      $.getJSON(syncURL, syncParams, function(response) {
        var i, len, p, project, ref, uuid;
        syncParams.seq_no = response.seq_no;
        syncParams.seq_no_global = response.seq_no_global;
        project = null;
        ref = response.Projects;
        for (i = 0, len = ref.length; i < len; i++) {
          p = ref[i];
          if (p.name === settings.projectName) {
            project = p;
            break;
          }
        }
        if (project) {
          uuid = (S4() + S4() + "-" + S4() + "-4" + S4().substr(0, 3) + "-" + S4() + "-" + S4() + S4() + S4()).toLowerCase();
          syncParams.commands = JSON.stringify([
            {
              type: "item_add",
              uuid: uuid,
              temp_id: uuid,
              args: {
                project_id: project.id,
                content: activeURL,
                date_string: "today"
              }
            }
          ]);
          return $.getJSON(syncURL, syncParams, function(response) {
            syncParams.seq_no = response.seq_no;
            syncParams.seq_no_global = response.seq_no_global;
            return window.alert("Added link to \"" + settings.projectName + "\"");
          });
        }
      });
      return false;
    });
    return S4 = function() {
      return (((1 + Math.random()) * 0x10000) | 0).toString(16).substring(1);
    };
  })(jQuery);

}).call(this);
